{% extends "layout.html" %}

{% block head_content %}
<!-- Add transition library for smoother animations -->
<style>
  /* Todo item styles */
  .todo-item {
    transition: all 0.3s ease;
    border-left-width: 4px;
    border-left-style: solid;
    border-left-color: transparent;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }
  
  .todo-item:hover {
    transform: translateX(5px);
    border-left-color: #3b82f6;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .todo-item.completed {
    opacity: 0.7;
    background-color: #f9fafb;
    border-left-color: #10b981;
  }
  
  .todo-item.overdue:not(.completed) {
    border-left-color: #ef4444;
  }
  
  .removing {
    opacity: 0;
    transform: translateX(100%);
  }
  
  /* New filter button styles */
  .filter-btn {
    min-width: 110px;
    transition: all 0.2s ease;
  }
  
  .filter-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .filter-btn.active {
    font-weight: 600;
  }
  
  /* Sort button styles */
  #sortDirection {
    transition: transform 0.2s ease;
  }
  
  .sort-desc svg {
    transform: rotate(180deg);
  }
  
  /* Todo actions */
  .todo-actions {
    opacity: 0.6;
    transition: opacity 0.2s ease;
  }
  
  .todo-item:hover .todo-actions {
    opacity: 1;
  }
  
  /* Popup styles */
  #todoPopup {
    transition: opacity 0.3s ease;
  }
  
  #todoPopup.flex {
    opacity: 1;
  }
  
  #todoPopup.hidden {
    opacity: 0;
    pointer-events: none;
  }
  
  #todoPopup .bg-white {
    transition: transform 0.3s ease;
  }
  
  #todoPopup.flex .bg-white {
    transform: scale(1);
  }
  
  #todoPopup.hidden .bg-white {
    transform: scale(0.9);
  }
  
  .todo-checkbox:checked + div h3 {
    text-decoration: line-through;
    color: #9ca3af;
  }
  
  /* Custom checkbox styles */
  .todo-checkbox {
    appearance: none;
    -webkit-appearance: none;
    position: relative;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #cbd5e1;
    border-radius: 9999px;
    background-color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    outline: none;
  }
  
  .todo-checkbox:checked {
    border-color: #3b82f6;
    background-color: #3b82f6;
  }
  
  .todo-checkbox:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 9999px;
    background-color: white;
  }
  
  /* Add Task Button Animation */
  .add-todo-btn {
    transition: all 0.3s ease;
  }
  
  .add-todo-btn:hover {
    transform: translateY(-2px);
  }
  
  .add-todo-btn:hover svg {
    transform: rotate(90deg);
  }
  
  .add-todo-btn svg {
    transition: transform 0.3s ease;
  }
  
  /* Responsive style adjustments */
  @media (max-width: 640px) {
    .filter-btn {
      min-width: auto;
      width: calc(50% - 0.25rem);
      margin-bottom: 0.25rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content - 2/3 width on desktop -->
    <div class="lg:col-span-2">
        <!-- Welcome and stats -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Welcome back, {{ current_user.username }}!</h2>
                {% if company %}
                <span class="text-sm text-gray-600">{{ company.name }}</span>
                {% endif %}
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-sm text-blue-600 font-medium">Total Balance</p>
                    <p class="text-2xl font-bold text-blue-800">{{ "${:,.2f}".format(total_balance) }}</p>
                </div>
                <div class="bg-red-50 rounded-lg p-4">
                    <p class="text-sm text-red-600 font-medium">Overdue Amount</p>
                    <p class="text-2xl font-bold text-red-800">{{ "${:,.2f}".format(overdue_amount) }}</p>
                </div>
            </div>
        </div>
        
        <!-- Recent Transactions -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-medium text-gray-800">Recent Transactions</h2>
                <a href="{{ url_for('all_transactions') }}" class="text-blue-600 hover:text-blue-800 text-sm">
                    View All
                </a>
            </div>
            
            {% if recent_transactions %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Date
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Client
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Description
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Amount
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for transaction in recent_transactions %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ transaction.date.strftime('%b %d, %Y') }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                <a href="{{ url_for('view_client_transactions', client_id=transaction.client.id) }}" class="hover:text-blue-600">
                                    {{ transaction.client.name }}
                                </a>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500">
                                {{ transaction.description }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium 
                                        {% if transaction.debit and transaction.debit > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                {% if transaction.debit and transaction.debit > 0 %}
                                -${{ "{:,.2f}".format(transaction.debit) }}
                                {% else %}
                                ${{ "{:,.2f}".format(transaction.credit) }}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <p class="text-gray-500">No recent transactions</p>
                <a href="{{ url_for('add_transaction') }}" class="mt-2 inline-block text-blue-600 hover:text-blue-700">
                    Record a transaction
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Overdue Invoices -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-medium text-gray-800">Overdue Invoices</h2>
                <a href="{{ url_for('all_transactions') }}?status=overdue" class="text-blue-600 hover:text-blue-800 text-sm">
                    View All
                </a>
            </div>
            
            {% if overdue_invoices %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Due Date
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Client
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Invoice #
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Amount
                            </th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Days Overdue
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for invoice in overdue_invoices %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ invoice.due_date.strftime('%b %d, %Y') }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                <a href="{{ url_for('view_client_transactions', client_id=invoice.client.id) }}" class="hover:text-blue-600">
                                    {{ invoice.client.name }}
                                </a>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ invoice.invoice_number or 'N/A' }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium text-red-600">
                                ${{ "{:,.2f}".format(invoice.debit) }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                {% set days_overdue = invoice.due_date and (today - invoice.due_date.date()).days or 0 %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if days_overdue > 30 %}bg-red-100 text-red-800
                                    {% elif days_overdue > 15 %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ days_overdue }} days
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <p class="text-gray-500">No overdue invoices</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Sidebar - 1/3 width on desktop -->
    <div>
        <!-- To-Do List -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-4 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Todo List
                </h2>
                <button onclick="showTodoPopup()" class="add-todo-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    New Task
                </button>
            </div>
            
            <!-- Filter and Sort Controls -->
            <div class="p-4 bg-white border-b border-gray-100">
                <!-- Filter Pills - Redesigned to match screenshot -->
                <div class="flex flex-wrap items-center mb-3 gap-1">
                    <a href="#" onclick="filterTodos('all'); return false;" 
                       class="inline-flex items-center px-3 py-1.5 rounded-md text-sm font-medium transition-colors relative filter-btn active bg-yellow-100 text-gray-800" 
                       data-filter="all">
                        <span class="absolute left-0 top-0 bottom-0 w-6 bg-yellow-300 rounded-l-md flex items-center justify-center text-sm">
                            =
                        </span>
                        <span class="pl-4">All</span>
                    </a>
                    
                    <a href="#" onclick="filterTodos('active'); return false;" 
                       class="inline-flex items-center px-3 py-1.5 rounded-md text-sm font-medium transition-colors relative filter-btn bg-yellow-100 text-gray-800" 
                       data-filter="active">
                        <span class="absolute left-0 top-0 bottom-0 w-6 bg-yellow-300 rounded-l-md flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                                <path d="M12 8v4l3 3" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </span>
                        <span class="pl-4">Active</span>
                    </a>
                    
                    <a href="#" onclick="filterTodos('completed'); return false;" 
                       class="inline-flex items-center px-3 py-1.5 rounded-md text-sm font-medium transition-colors relative filter-btn bg-yellow-100 text-gray-800" 
                       data-filter="completed">
                        <span class="absolute left-0 top-0 bottom-0 w-6 bg-yellow-300 rounded-l-md flex items-center justify-center">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M5 12l5 5L20 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        <span class="pl-4">Completed</span>
                    </a>
                    
                    <a href="#" onclick="filterTodos('overdue'); return false;" 
                       class="inline-flex items-center px-3 py-1.5 rounded-md text-sm font-medium transition-colors relative filter-btn bg-yellow-100 text-gray-800" 
                       data-filter="overdue">
                        <span class="absolute left-0 top-0 bottom-0 w-6 bg-yellow-300 rounded-l-md flex items-center justify-center">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                                <path d="M12 7v5" stroke-width="2" stroke-linecap="round"/>
                                <path d="M12 16v.01" stroke-width="3" stroke-linecap="round"/>
                            </svg>
                        </span>
                        <span class="pl-4">Overdue</span>
                    </a>
                </div>
                
                <!-- Sort Controls - Redesigned -->
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-500 flex items-center" id="currentFilterText">
                        <svg class="w-4 h-4 mr-1 text-blue-500 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke-width="1.5"/>
                            <path d="M12 8v4" stroke-width="1.5" stroke-linecap="round"/>
                            <path d="M12 16v.01" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Viewing all tasks
                    </div>
                    
                    <div class="flex items-center border rounded-md overflow-hidden">
                        <div class="px-2 py-1.5 bg-white text-sm text-gray-600">
                            Sort by
                        </div>
                        <select id="sortSelect" onchange="sortTodos()" class="py-1.5 pl-2 pr-8 border-none text-sm focus:outline-none focus:ring-0 appearance-none bg-white">
                            <option value="due_date">Due Date</option>
                            <option value="title">Title</option>
                            <option value="priority">Priority</option>
                        </select>
                        <button onclick="toggleSortDirection()" id="sortDirection" class="p-1.5 bg-white border-l">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Todo List -->
            <div id="todoList" class="space-y-3 px-6 py-4 max-h-[480px] overflow-y-auto">
                {% for todo in todos %}
                <div class="todo-item bg-white rounded-lg shadow-sm border border-gray-200 p-4 transition-all duration-200 hover:shadow-md" 
                     data-id="{{ todo.id }}" 
                     data-completed="{{ todo.is_completed|lower }}"
                     data-due-date="{{ todo.due_date.strftime('%Y-%m-%d') if todo.due_date else '' }}"
                     data-priority="{{ todo.priority }}">
                    <div class="flex items-start gap-3">
                        <!-- Checkbox -->
                        <div class="flex-shrink-0 pt-0.5">
                            <input type="checkbox" 
                                   class="todo-checkbox w-5 h-5 rounded-full border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                                   {% if todo.is_completed %}checked{% endif %}
                                   data-id="{{ todo.id }}"
                                   onchange="toggleTodo(this.dataset.id, this.checked)">
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-grow min-w-0">
                            <div class="flex items-start justify-between gap-2">
                                <h3 class="text-base font-medium text-gray-900 {% if todo.is_completed %}line-through text-gray-500{% endif %}">
                                    {{ todo.title }}
                                </h3>
                                <div class="flex items-center gap-2 todo-actions">
                                    {% if todo.priority == 'high' %}
                                    <span class="px-2 py-1 text-xs font-medium text-red-700 bg-red-100 rounded-full flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                        </svg>
                                        High
                                    </span>
                                    {% elif todo.priority == 'medium' %}
                                    <span class="px-2 py-1 text-xs font-medium text-yellow-700 bg-yellow-100 rounded-full flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
                                        </svg>
                                        Medium
                                    </span>
                                    {% else %}
                                    <span class="px-2 py-1 text-xs font-medium text-green-700 bg-green-100 rounded-full flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                                        </svg>
                                        Low
                                    </span>
                                    {% endif %}
                                    
                                    <button data-id="{{ todo.id }}" class="edit-todo-btn p-1.5 text-gray-400 hover:text-blue-600 rounded-full hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                        </svg>
                                    </button>
                                    <button data-id="{{ todo.id }}" class="delete-todo-btn p-1.5 text-gray-400 hover:text-red-600 rounded-full hover:bg-red-50 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                        {% if todo.description %}
                            <p class="mt-1 text-sm text-gray-600 {% if todo.is_completed %}line-through text-gray-400{% endif %}">
                                {{ todo.description }}
                            </p>
                        {% endif %}
                            
                        {% if todo.due_date %}
                            <div class="mt-2 flex items-center gap-2">
                                <svg class="w-4 h-4 {% if todo.is_overdue %}text-red-500{% elif todo.is_completed %}text-gray-400{% else %}text-blue-500{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <span class="text-sm {% if todo.is_overdue %}text-red-600 font-medium{% elif todo.is_completed %}text-gray-400{% else %}text-gray-600{% endif %}">
                                    Due: {{ todo.due_date.strftime('%b %d, %Y') }}
                                </span>
                                {% if todo.is_overdue and not todo.is_completed %}
                                <span class="px-2 py-0.5 text-xs font-semibold text-red-800 bg-red-100 rounded-full animate-pulse">
                                    Overdue
                                </span>
                                {% endif %}
                            </div>
                        {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No tasks</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by creating a new task.</p>
                </div>
            {% endfor %}
        </div>
        
        <!-- Quick Links -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-medium text-gray-800 mb-4">Quick Links</h2>
            <div class="grid grid-cols-2 gap-2">
                <a href="{{ url_for('add_client') }}" class="flex items-center p-3 rounded-lg hover:bg-blue-50 text-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" />
                    </svg>
                    <span class="text-sm">New Client</span>
                </a>
                <a href="{{ url_for('add_transaction') }}" class="flex items-center p-3 rounded-lg hover:bg-blue-50 text-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-sm">New Transaction</span>
                </a>
                <a href="{{ url_for('list_clients') }}" class="flex items-center p-3 rounded-lg hover:bg-blue-50 text-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                    </svg>
                    <span class="text-sm">All Clients</span>
                </a>
                <a href="{{ url_for('all_transactions') }}" class="flex items-center p-3 rounded-lg hover:bg-blue-50 text-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-sm">All Transactions</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Todo Popup -->
<div id="todoPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 transform transition-all">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200 rounded-t-xl">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center" id="popupTitle">
                    <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    New Task
                </h3>
                <button onclick="hideTodoPopup()" class="text-gray-400 hover:text-gray-500 p-1 rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="p-6">
            <form id="todoForm" onsubmit="handleTodoSubmit(event)" class="space-y-4">
                <input type="hidden" id="todoId" name="id">
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Title <span class="text-red-500 ml-1">*</span>
                    </label>
                    <input type="text" id="title" name="title" required 
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm transition-all duration-200">
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
                        </svg>
                        Description
                    </label>
                    <textarea id="description" name="description" rows="3"
                              class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm transition-all duration-200"></textarea>
                </div>
                <div>
                    <label for="due_date" class="block text-sm font-medium text-gray-700 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Due Date
                    </label>
                    <input type="date" id="due_date" name="due_date"
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm transition-all duration-200">
                </div>
                <div>
                    <label for="priority" class="block text-sm font-medium text-gray-700 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                        </svg>
                        Priority
                    </label>
                    <select id="priority" name="priority"
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm transition-all duration-200">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <div class="bg-white border-2 rounded-full border-gray-300 w-5 h-5 flex flex-shrink-0 justify-center items-center mr-2 focus-within:border-blue-500">
                        <input type="checkbox" id="is_completed" name="is_completed"
                               class="opacity-0 absolute h-5 w-5 cursor-pointer">
                        <svg class="fill-current hidden w-3 h-3 text-blue-600 pointer-events-none" viewBox="0 0 20 20">
                            <path d="M0 11l2-2 5 5L18 3l2 2L7 18z"/>
                        </svg>
                    </div>
                    <label for="is_completed" class="select-none text-sm text-gray-700">Mark as completed</label>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="hideTodoPopup()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-sm transition-all duration-200">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block content_javascripts %}
<script>
let currentFilter = 'all';
let currentSort = 'due_date'; // Default to due date sorting
let sortDirection = 'asc';

// Initialize todo items with correct classes based on their state
function initializeTodoItems() {
    document.querySelectorAll('.todo-item').forEach(todo => {
        const isCompleted = todo.dataset.completed === 'true';
        const dueDate = todo.dataset.dueDate;
        const isOverdue = dueDate && new Date(dueDate) < new Date() && !isCompleted;
        
        // Set completed class
        todo.classList.toggle('completed', isCompleted);
        
        // Set overdue class
        todo.classList.toggle('overdue', isOverdue);
    });
}

// Initialize todo functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for edit and delete buttons
    document.querySelectorAll('.edit-todo-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const todoId = this.dataset.id;
            showTodoPopup(todoId);
        });
    });
    
    document.querySelectorAll('.delete-todo-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const todoId = this.dataset.id;
            deleteTodo(todoId);
        });
    });
    
    // Initialize todo items with the correct classes
    initializeTodoItems();
    
    // Set initial filter to "All"
    filterTodos('all');
    
    // Add a small comment for developers
    console.log('Todo functionality initialized - drag-and-drop disabled');
});

function filterTodos(filter) {
    currentFilter = filter;
    const todos = document.querySelectorAll('.todo-item');
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    // Update active filter button
    filterButtons.forEach(btn => {
        const isActive = btn.getAttribute('data-filter') === filter;
        btn.classList.toggle('active', isActive);
    });
    
    // Update filter indicator text
    const filterTextMap = {
        'all': 'Viewing all tasks',
        'active': 'Viewing active tasks',
        'completed': 'Viewing completed tasks',
        'overdue': 'Viewing overdue tasks'
    };
    
    document.getElementById('currentFilterText').innerHTML = `
        <svg class="w-4 h-4 mr-1 text-blue-500 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke-width="1.5"/>
            <path d="M12 8v4" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M12 16v.01" stroke-width="2" stroke-linecap="round"/>
        </svg>
        ${filterTextMap[filter] || 'Viewing all tasks'}
    `;
    
    // Show/hide todos based on filter
    let visibleCount = 0;
    
    todos.forEach(todo => {
        const isCompleted = todo.dataset.completed === 'true';
        const dueDate = todo.dataset.dueDate;
        const isOverdue = dueDate && new Date(dueDate) < new Date() && !isCompleted;
        
        let show = false;
        switch(filter) {
            case 'all':
                show = true;
                break;
            case 'active':
                show = !isCompleted;
                break;
            case 'completed':
                show = isCompleted;
                break;
            case 'overdue':
                show = isOverdue;
                break;
        }
        
        todo.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // Show/hide empty state
    const emptyState = document.querySelector('.todo-empty-state');
    const todoList = document.getElementById('todoList');
    
    if (visibleCount === 0) {
        // Create empty state if it doesn't exist
        if (!emptyState) {
            const newEmptyState = document.createElement('div');
            newEmptyState.className = 'todo-empty-state text-center py-8';
            newEmptyState.innerHTML = `
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No ${filter} tasks</h3>
                <p class="mt-1 text-sm text-gray-500">
                    ${filter === 'all' ? 'Get started by creating a new task.' : 
                      filter === 'active' ? 'All your tasks are completed.' : 
                      filter === 'completed' ? 'You have no completed tasks yet.' : 
                      'You have no overdue tasks.'}
                </p>
            `;
            todoList.appendChild(newEmptyState);
        } else {
            // Update existing empty state
            const header = emptyState.querySelector('h3');
            const paragraph = emptyState.querySelector('p');
            
            if (header) header.textContent = `No ${filter} tasks`;
            if (paragraph) {
                paragraph.textContent = filter === 'all' ? 'Get started by creating a new task.' : 
                                       filter === 'active' ? 'All your tasks are completed.' : 
                                       filter === 'completed' ? 'You have no completed tasks yet.' : 
                                       'You have no overdue tasks.';
            }
            
            emptyState.style.display = '';
        }
    } else if (emptyState) {
        emptyState.style.display = 'none';
    }
}

function sortTodos() {
    currentSort = document.getElementById('sortSelect').value;
    const todoList = document.getElementById('todoList');
    const todos = Array.from(todoList.children).filter(item => 
        item.classList.contains('todo-item') && item.style.display !== 'none'
    );
    
    todos.sort((a, b) => {
        let valueA, valueB;
        
        switch(currentSort) {
            case 'due_date':
                valueA = a.dataset.dueDate || '9999-12-31';
                valueB = b.dataset.dueDate || '9999-12-31';
                break;
            case 'title':
                valueA = a.querySelector('h3').textContent.toLowerCase();
                valueB = b.querySelector('h3').textContent.toLowerCase();
                break;
            case 'priority':
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                valueA = priorityOrder[a.dataset.priority];
                valueB = priorityOrder[b.dataset.priority];
                break;
            default:
                return 0;
        }
        
        if (sortDirection === 'asc') {
            return valueA > valueB ? 1 : -1;
        } else {
            return valueA < valueB ? 1 : -1;
        }
    });
    
    // Reappend todos in the new order
    todos.forEach(todo => todoList.appendChild(todo));
    
    // Log sorting for debugging
    console.log(`Sorted todos by ${currentSort} (${sortDirection})`);
}

function toggleSortDirection() {
    const button = document.getElementById('sortDirection');
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    button.classList.toggle('sort-desc', sortDirection === 'desc');
    sortTodos();
}

function showTodoPopup(todoId = null) {
    const popup = document.getElementById('todoPopup');
    const form = document.getElementById('todoForm');
    const title = document.getElementById('popupTitle');
    
    // Reset form
    form.reset();
    document.getElementById('todoId').value = '';
    
    // Initialize custom checkbox
    const checkbox = document.getElementById('is_completed');
    const checkmark = checkbox.nextElementSibling;
    updateCustomCheckbox(checkbox, checkmark);
    
    if (todoId) {
        // Edit mode
        title.innerHTML = `
            <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
            </svg>
            Edit Task
        `;
        const todo = document.querySelector(`.todo-item[data-id="${todoId}"]`);
        if (todo) {
            document.getElementById('todoId').value = todoId;
            document.getElementById('title').value = todo.querySelector('h3').textContent.trim();
            document.getElementById('description').value = todo.querySelector('p')?.textContent.trim() || '';
            document.getElementById('due_date').value = todo.dataset.dueDate || '';
            document.getElementById('priority').value = todo.dataset.priority;
            
            // Set checkbox and update visual
            checkbox.checked = todo.dataset.completed === 'true';
            updateCustomCheckbox(checkbox, checkmark);
        }
    } else {
        // New task mode
        title.innerHTML = `
            <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            New Task
        `;
    }
    
    popup.classList.remove('hidden');
    popup.classList.add('flex');
}

// Function to update custom checkbox visuals
function updateCustomCheckbox(checkbox, checkmark) {
    if (checkbox && checkmark) {
        checkmark.classList.toggle('hidden', !checkbox.checked);
    }
}

// Add event listener for checkbox changes
document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('is_completed');
    const checkmark = checkbox.nextElementSibling;
    
    checkbox.addEventListener('change', function() {
        updateCustomCheckbox(this, checkmark);
    });
});

function hideTodoPopup() {
    const popup = document.getElementById('todoPopup');
    popup.classList.add('hidden');
    popup.classList.remove('flex');
}

async function handleTodoSubmit(event) {
    event.preventDefault();
    
    const form = event.target;
    const todoId = document.getElementById('todoId').value;
    const isNewTodo = !todoId;
    
    // Get form data
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();
    const dueDate = document.getElementById('due_date').value;
    const priority = document.getElementById('priority').value;
    const isCompleted = document.getElementById('is_completed').checked;
    
    // Basic validation
    if (!title) {
        alert('Please enter a title for the task.');
        document.getElementById('title').focus();
        return;
    }
    
    // Prepare data
    const data = {
        title: title,
        description: description,
        due_date: dueDate,
        priority: priority,
        is_completed: isCompleted
    };
    
    // Show loading state
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.textContent = 'Saving...';
    
    try {
        const url = isNewTodo ? '/todos/add' : `/todos/${todoId}/edit`;
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // Close popup
            hideTodoPopup();
            
            // For simplicity, refresh the page to show the updated todo
            // In a production app, you might want to update the DOM directly
            window.location.reload();
        } else {
            console.error('Error saving todo:', result.message);
            alert(result.message || 'There was an error saving your task.');
        }
    } catch (error) {
        console.error('Error saving todo:', error);
        alert('There was an error saving your task. Please try again.');
    } finally {
        // Reset button state
        submitButton.disabled = false;
        submitButton.textContent = originalText;
    }
}

async function toggleTodo(id, isCompleted) {
    try {
        const response = await fetch(`/todos/${id}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ is_completed: isCompleted })
        });
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        const result = await response.json();
        if (result.success) {
            const todo = document.querySelector(`.todo-item[data-id="${id}"]`);
            if (todo) {
                // Update data attribute
                todo.dataset.completed = isCompleted ? 'true' : 'false';
                
                // Update class for styling
                todo.classList.toggle('completed', isCompleted);
                
                // Update text styling
                const title = todo.querySelector('h3');
                const description = todo.querySelector('p');
                const dueDate = todo.querySelector('.text-sm:last-child');
                
                if (title) {
                    if (isCompleted) {
                        title.classList.add('line-through', 'text-gray-500');
                        title.classList.remove('text-gray-900');
                    } else {
                        title.classList.remove('line-through', 'text-gray-500');
                        title.classList.add('text-gray-900');
                    }
                }
                
                if (description) {
                    if (isCompleted) {
                        description.classList.add('line-through', 'text-gray-400');
                        description.classList.remove('text-gray-600');
                    } else {
                        description.classList.remove('line-through', 'text-gray-400');
                        description.classList.add('text-gray-600');
                    }
                }
                
                // Reapply filter to hide/show if needed
                filterTodos(currentFilter);
            }
        } else {
            console.error('Error toggling todo completion:', result.message);
            // Revert the checkbox
            const checkbox = document.querySelector(`.todo-checkbox[data-id="${id}"]`);
            if (checkbox) {
                checkbox.checked = !isCompleted;
            }
            alert(result.message || 'An error occurred');
        }
    } catch (error) {
        console.error('Error:', error);
        // Revert the checkbox
        const checkbox = document.querySelector(`.todo-checkbox[data-id="${id}"]`);
        if (checkbox) {
            checkbox.checked = !isCompleted;
        }
        alert('An error occurred while updating the task');
    }
}

// Helper function to get CSRF token
function getCsrfToken() {
    const csrfCookie = document.cookie.split(';')
        .find(cookie => cookie.trim().startsWith('csrftoken='));
    
    if (csrfCookie) {
        return csrfCookie.split('=')[1];
    }
    
    // If no cookie, try meta tag
    const csrfInput = document.querySelector('meta[name="csrf-token"]');
    if (csrfInput) {
        return csrfInput.getAttribute('content');
    }
    
    // If still not found, look for hidden input
    const csrfHidden = document.querySelector('input[name="csrf_token"]');
    if (csrfHidden) {
        return csrfHidden.value;
    }
    
    return '';
}

async function deleteTodo(id) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }
    
    const todo = document.querySelector(`.todo-item[data-id="${id}"]`);
    if (!todo) return;
    
    todo.classList.add('removing');
    
    try {
        const response = await fetch(`/todos/${id}/delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        const result = await response.json();
        if (result.success) {
            setTimeout(() => {
                todo.remove();
                
                // Show empty state if no more todos left
                const visibleTodos = document.querySelectorAll('.todo-item:not([style*="display: none"])');
                if (visibleTodos.length === 0) {
                    // Create an empty state message if it doesn't exist
                    let emptyState = document.querySelector('.todo-empty-state');
                    if (!emptyState) {
                        emptyState = document.createElement('div');
                        emptyState.className = 'todo-empty-state text-center py-8';
                        emptyState.innerHTML = `
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No tasks</h3>
                            <p class="mt-1 text-sm text-gray-500">Get started by creating a new task.</p>
                        `;
                        const todoList = document.getElementById('todoList');
                        todoList.appendChild(emptyState);
                    }
                    emptyState.style.display = '';
                }
            }, 300);
        } else {
            todo.classList.remove('removing');
            console.error('Error deleting todo:', result.message);
            alert(result.message || 'An error occurred');
        }
    } catch (error) {
        todo.classList.remove('removing');
        console.error('Error:', error);
        alert('An error occurred while deleting the task');
    }
}
</script>
{% endblock %} 